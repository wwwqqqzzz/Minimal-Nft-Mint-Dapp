# 最小 NFT 铸造 DApp — 实施路线图（Roadmap）

本文档用于跟踪“无需后端的登录/注册 + 我的仓库 + 白名单/抽奖/合成/销毁”等功能的分阶段落地方案，便于持续实施与验收。

## 1. 背景与目标
- 目标：在不自建后端的前提下，让用户“钱包即登录”，进入站点后能看到“自己的 NFT 仓库”，并逐步支持白名单、抽奖、合成、销毁等差异化功能。
- 思路：所有权限与业务判定放在合约层（以 msg.sender 为准），前端仅进行会话与体验增强，不引入中心化后端依赖。

## 2. 设计原则
- 最小可行：每个阶段都能独立上线并带来实用价值。
- 安全优先：关键权限全在合约里校验；前端只做“识别与引导”。
- 可演进：先从链上直接读取，后续可平滑接入索引服务提升体验。

## 3. 当前状态简述
- 合约
  - 已有 MyNFT.sol 与 SelectableNFT.sol，两者均继承 ERC721Enumerable，可按地址枚举 NFT。
  - MyNFT 已新增 merkleRoot、allowlistMint 与 allowlistMinted 统计，支持基于 Merkle Proof 的白名单铸造；可通过 setMerkleRoot 动态更新根（已上链验证）。
  - SelectableNFT 已覆盖 `_burn`（配合 URIStorage 清理），但尚未对外开放公开 burn 接口。
  - 尚未内置合成（fuse）、抽奖（VRF 或 Commit-Reveal）逻辑。
- 前端
  - 已有铸造应用与模板选择应用。
  - 已集成“帮助中心”入口与模态。
  - 签名登录与 Header“登录/退出”已落地（本地会话，24h 过期）。基础的“我的仓库/持有 NFT 列表”视图与白名单铸造入口已集成；Proof 暂采用手动粘贴输入，后续将优化为本地生成或查表。
  - 新增“市场（演示版）”页面与导航入口：按 totalSupply 回溯近 N 个 token 展示缩略图与元数据按钮；购买为占位，后续接入 Market 合约实现一口价闭环。

> 注：后续阶段如需在两份合约之间做取舍或同时支持，请在“待确认项”中确认优先顺序。

## 4. 分阶段计划

### 阶段 1：前端签名登录 + “我的仓库”骨架（高优先｜已完成）
- 交付物
  - “钱包即登录”流程：连接钱包后触发一次文本签名，生成本地会话（localStorage），支持退出清除。
  - Header 增加“登录/退出”与地址显示。
  - 新增“我的仓库”页面/视图：列出当前地址持有的 NFT，含加载、空态与错误态，支持分页/懒加载。
- 技术要点
  - EIP-191 文本签名；nonce + 有效期；本地持久化与恢复；账户/网络切换联动更新。
  - 通过 ERC721Enumerable 的 balanceOf + tokenOfOwnerByIndex 枚举钱包持有 NFT。
- 前端改动（示例）
  - src/utils/auth.js：封装签名登录、会话存取、有效期校验。
  - src/components/AppHeader.js：新增“登录/退出”、地址展示。
  - src/components/Inventory.js：展示“我的仓库”。
  - src/index.js：统一管理登录态与视图切换。
- 合约改动：无（直接读取）。
- 验收标准
  - 刷新后可恢复登录态（有效期内）；切换账户/网络时 UI 同步更新。
  - “我的仓库”能稳定列出对应地址持有的 NFT。

### 阶段 2：白名单（Merkle Allowlist）（高优先｜进行中）
- 交付物
  - 合约新增 merkleRoot 与 allowlistMint(bytes32[] proof) 入口（或分支现有 mint）。
  - 前端提供白名单铸造表单，自动校验与报错提示。
- 技术要点
  - Proof 生成策略二选一：
    - A：构建时内置地址列表，前端用 merkletreejs 生成 proof（适合小名单）。
    - B：构建时预生成地址->proof 映射 JSON，前端查表（适合大名单）。
- 前端改动
  - 新增白名单铸造卡片/页面，接入 proof 生成/查表与合约调用。
- 合约改动
  - 增加 merkleRoot、onlyOwner 的 setter、allowlistMint。
- 验收标准
  - 非白名单地址调用失败，白名单地址成功铸造；更换 merkleRoot 立即生效。

### 阶段 2.5：交易市场 MVP（固定价一口价）（高优先｜待启动）
- 交付物
  - 合约 + 前端完成一口价上架/购买/下架闭环；前端市场页可浏览在售列表并完成购买；仓库与市场视图联动刷新。
- 合约要点
  - List/Unlist/Buy/Withdraw（pull-payment 提现模型），加入 ReentrancyGuard，遵循 Checks-Effects-Interactions；事件：Listed、Unlisted、Purchased；可选 EIP-2981 版税支持；可先限制到项目内两份 ERC721。
- 前端要点
  - “我的仓库”卡片：新增“上架”入口（输入价格，交易成功后状态更新为已上架/可下架/可改价）。
  - “市场”页面：展示在售列表、按价格/时间排序、购买按钮与交易反馈；失败降级链上查询，提供刷新与轮询。
- 运维脚本
  - 部署市场合约、setApprovalForAll 引导与校验、基础验收用例脚本。
- 验收标准
  - 上架权限正确、重复上架拦截；购买后归属与余额正确变更；事件触发与前端状态一致。

### 阶段 3：销毁（Burn）（高优先）
- 交付物
  - 合约暴露安全的 burn 接口（仅 tokenOwner 或授权者可操作）。
  - 前端在“我的仓库”卡片中增加“销毁”按钮与二次确认、交易状态反馈。
- 技术要点
  - 继承 ERC721Burnable 或实现 public burn -> _burn。
- 验收标准
  - 成功销毁后列表即时更新；非 owner 无法销毁。

### 阶段 4：合成（Fusion）（中优先）
- 交付物
  - 合约新增 fuse(uint256[] burnIds) 或带配方的合成接口：燃烧多枚旧 NFT，铸造 1 枚新 NFT。
  - 前端支持多选卡片与合成流程（规则提示、失败场景提示）。
- 技术要点
  - 权限校验、配方/素材验证、元数据生成（可按规则确定新 tokenURI）。
- 验收标准
  - 合成成功后，旧 NFT 从列表移除，新 NFT 出现在仓库中。

### 阶段 5：抽奖（Raffle）（中优先）
- 交付物
  - MVP：Commit-Reveal（零外部依赖，可链上验证）。后续可升级为 Chainlink VRF。
  - 前端提供报名、提交承诺、揭示与开奖展示。
- 技术要点
  - Commit(bytes32) / Reveal(secret) / Settle() 流程、超时/未揭示处理策略、奖品分配规则。
- 验收标准
  - 抽奖流程可验证与可追溯；异常路径处理明确。

### 阶段 6：仓库数据源优化（低优先）
- 交付物
  - 将“我的仓库”的数据获取从链上遍历升级为索引服务（The Graph/第三方 NFT API），显著提升加载速度。
- 技术要点
  - 新增数据适配层：优先用索引服务，失败时降级到链上遍历。
- 验收标准
  - 在 NFT 数量较大时仍有良好体验（可在数千级别内流畅加载）。

### 阶段 6.2：市场数据源优化（低优先）
- 交付物
  - 基于事件回放或 The Graph 构建“上架/成交”索引；市场页支持分页、筛选与排序；前端与合约事件联动更新。
- 技术要点
  - 建立上市/成交实体；后端零依赖，优先用 The Graph，失败降级链上事件回放；增加数据一致性校验与重建流程。
- 验收标准
  - 在活跃交易下仍保持列表稳定与延迟可接受；断线/重启后可快速恢复。

### 阶段 7：帮助中心与多语言（低优先）
- 交付物
  - 帮助中心补充各功能指南与风控提示；引入 i18n（中文/英文）。
- 技术要点
  - i18next/lingui 等方案；语言包维护与检测。
- 验收标准
  - 主要页面与帮助内容可中/英切换，无明显漏翻。

## 5. 风险与备选方案
- 登录安全与伪装：前端签名仅做本地会话标记，合约层一律以 msg.sender 权限为准；避免把权限逻辑放到前端。
- 列表性能：短期链上遍历 + 懒加载；中期接 The Graph/第三方 API。
- 抽奖成本：VRF 需资金与配置，MVP 先用 Commit-Reveal。

## 6. 待确认项（请在实施前勾选）
- [ ] 合约优先支持：MyNFT / SelectableNFT / 两者
- [ ] 白名单 proof 方案：A（本地生成）/ B（构建期预生成映射）
- [ ] 抽奖方式：A（Commit-Reveal）/ B（Chainlink VRF）

## 7. 里程碑与时间建议
- 第 1 周：阶段 1、阶段 2、阶段 3（核心能力：登录、仓库、白名单与销毁）
- 第 2 周：阶段 4、阶段 5（增值能力：合成与抽奖）
- 第 3 周：阶段 6、阶段 7（体验与国际化）

## 8. 任务清单（持续更新）
- [x] 阶段 1：前端签名登录 + 我的仓库（已完成）
- [ ] 阶段 2：白名单（Merkle）（进行中）
- [ ] 阶段 2.5：交易市场 MVP（固定价一口价）
- [ ] 阶段 3：销毁（Burn）
- [ ] 阶段 4：合成（Fusion）
- [ ] 阶段 5：抽奖（Raffle）
- [ ] 阶段 6：仓库数据源优化
- [ ] 阶段 6.2：市场数据源优化
- [ ] 阶段 7：帮助中心与多语言

## 9. 执行记录（填充中）
- 2025-08-20：合约 MyNFT 增加 merkleRoot/allowlistMint/allowlistMinted，并支持 setMerkleRoot；前端集成白名单铸造入口与本地签名登录；修复 App.js 中 allowlistMint 作用域与若干 no-undef 报错；本地开发服务器在 PowerShell 环境变量设置上待进一步适配。
- 2025-08-20：新增“市场（演示版）”页面与 Header 入口；市场页按 totalSupply 回溯近 N 个 token 展示缩略图与元数据按钮；购买为占位，等待 Market 合约落地。
- 2025-xx-xx：创建 Roadmap 文档，确认实施路线。

## 10. 变更日志
- v0.2：阶段 1 完成；启动阶段 2（合约端完成，前端入口已接入，待完善 proof 生成/查表与校验体验）。
- v0.1：建立初版路线图与分阶段目标。

## 11. 开发环境与运行指引（Windows/PowerShell）
- 固定端口启动（PowerShell，推荐在 frontend 目录执行）
  - 交互式当前会话生效：
    - $env:PORT=3010; $env:BROWSER="none"; npm start
  - 注意：上述环境变量仅对当前 PowerShell 会话有效；如端口 3010 被占用，CRA 会询问是否在其他端口继续运行。
- 在 CMD 启动（可在 frontend 目录执行）
  - set PORT=3010 && set BROWSER=none && npm start
- 在 Git Bash 或类 Unix Shell 启动
  - PORT=3010 BROWSER=none npm start
- 常见问题定位
  - “The ampersand (&) character is not allowed”：PowerShell 将 & 当作调用运算符，不要用 & 串联命令；在 PowerShell 中使用分号 ; 分隔，或在 CMD/Git Bash 中使用 &&。
  - “端口被占用（Would you like to run the app on another port?）”：输入 Y 继续，或重新设置 PORT 后再执行。
  - npm 的用户配置告警：通常为无效或未知字段；可使用 npm config list -l 排查，或在不影响构建的前提下忽略。

## 12. 阶段 2 详细拆解与验收用例（Merkle Allowlist）
- 策略选择（待确认）
  - A 本地生成 proof（引入 merkletreejs）：适合小名单；打包体积略增；名单哈希或明文在前端可被还原，请注意隐私边界。
  - B 构建期预生成映射（proofs.json 查表）：适合大名单与多环境；便于热更新；需妥善控制构建产物中暴露的字段（仅暴露必要 proof 与地址）。
- 前端改动要点
  - 在白名单铸造视图中：
    - 地址自动填充当前已连接账户；
    - Proof 获取：A 路径为前端现算；B 路径为从 proofs.json 查表；
    - 调用前预检：isAddress 校验、网络/链 ID 校验、按钮 loading/防抖、错误信息解码与展示；
    - 成功反馈：展示交易哈希与区块浏览器链接；
    - 辅助文案：如何获取/更新 proof、非白名单说明与联系指引。
- 合约交互与运维
  - setMerkleRoot 仅限 owner：预留部署/变更脚本（后续新增 scripts/set-merkle-root.js）；
  - 变更 merkleRoot 后，应同步更新前端 proof 生成/查表数据并回归测试。
- 验收用例
  - 白名单地址提交有效 proof 能成功铸造；
  - 非白名单地址或无效 proof 调用 revert；
  - 更新 merkleRoot 后，旧 proof 立即失效；
  - 重复铸造受 allowlistMinted 限制（同地址仅允许一次或按约定次数）。

## 13. 下一步计划（本周）
- [ ] 明确白名单 proof 策略（A 本地生成 / B 构建期映射）。
- [ ] 若选 A：添加 dev 依赖 merkletreejs，编写前端 proof 生成与校验逻辑；
- [ ] 若选 B：编写 Node 生成脚本（输入地址列表 -> 输出 proofs.json），在构建流程中接入；
- [ ] 完善前端白名单表单：自动填充地址、预检、交互态（loading/禁用）、错误提示与成功反馈；
- [ ] 增加 setMerkleRoot 运维脚本与验证流程（仅 owner 调用），并补充回归用例；
- [ ] 启动阶段 2.5：设计并实现固定价 Market 合约 + 前端“上架/购买”闭环（含部署脚本与 approval 引导）；
- [ ] 启动阶段 3 设计：在合约侧公开安全 burn 接口（或采用 ERC721Burnable），前端在“我的仓库”卡片加入“销毁”按钮与确认弹窗占位；
- [ ] 本地 E2E 验证：签名登录 -> 查看“我的仓库” -> 白名单铸造成功与失败路径 ->（预研）销毁流程占位与 UI。

— 本文档为持续更新文档，后续将根据实施进度补充脚本路径、接口签名与 UI 截图。

— 文档位置：`doc/ROADMAP.md`（该文件会随开发推进持续更新）